<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stellar AI - Backup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              gray: { 850: '#1f2937', 900: '#111827', 950: '#030712' },
              stellar: { light: '#a78bfa', DEFAULT: '#8b5cf6', dark: '#7c3aed' }
            },
            animation: { 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
          },
        },
      }
    </script>
    <style>
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
    <!-- Babel for in-browser compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Import Map for Modules -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0",
        "@google/genai": "https://esm.sh/@google/genai@0.1.1",
        "react-markdown": "https://esm.sh/react-markdown@9.0.1"
      }
    }
    </script>
  </head>
  <body class="overflow-hidden bg-gray-900 text-gray-100">
    <div id="root"></div>
    
    <script type="text/babel" data-type="module" data-presets="typescript,react">
      import React, { useState, useEffect, useRef, useMemo } from "react";
      import ReactDOM from "react-dom/client";
      import { GoogleGenAI, HarmCategory, HarmBlockThreshold } from "@google/genai";
      import ReactMarkdown from "react-markdown";
      import { 
        Send, Bot, User, Cpu, Swords, Code, Film, 
        Image as ImageIcon, Sparkles, Download, AlertTriangle, 
        X, Zap, Activity, Settings, Github, Grid2X2, Star, Lock, Box,
        Palette, Moon, Sun
      } from "lucide-react";

      // --- TYPES ---
      enum MessageRole { USER = 'user', MODEL = 'model', SYSTEM = 'system' }
      enum AiSpeed { DEEP_THINKING = 'DEEP_THINKING', NORMAL = 'NORMAL', FAST = 'FAST', VERY_FAST = 'VERY_FAST', EXTREMELY_FAST = 'EXTREMELY_FAST' }
      enum BsdCharacter { NONE = 'NONE', DAZAI = 'DAZAI', CHUUYA = 'CHUUYA', ATSUSHI = 'ATSUSHI', AKUTAGAWA = 'AKUTAGAWA', RANPO = 'RANPO', FYODOR = 'FYODOR', NIKOLAI = 'NIKOLAI', KUNIKIDA = 'KUNIKIDA', YOSANO = 'YOSANO', POE = 'POE' }
      enum AppMode { CHAT = 'CHAT', CHESS = 'CHESS', CODING = 'CODING', SCRIPT_WRITER = 'SCRIPT_WRITER' }
      enum AppTheme { DARK = 'DARK', LIGHT = 'LIGHT', LILA = 'LILA' }

      // --- CONSTANTS ---
      const API_KEY = "AIzaSyA7Oyq-ZDNUnxhYS5pvgRhWjFU_UF7hbX8";
      const SYSTEM_INSTRUCTIONS = {
        [BsdCharacter.NONE]: "You are Stellar AI, a helpful, intelligent, and advanced AI assistant.",
        [BsdCharacter.DAZAI]: "You are Osamu Dazai from Bungo Stray Dogs. You are enigmatic, cheerful yet nihilistic, intelligent, and often tease others. You talk about suicide casually but never actually go through with it. You are a member of the Armed Detective Agency.",
        [BsdCharacter.CHUUYA]: "You are Chuuya Nakahara from Bungo Stray Dogs. You are short-tempered, arrogant, blunt, but loyal to the Port Mafia. You hate Dazai with a passion. You control gravity. Do not be polite.",
        [BsdCharacter.ATSUSHI]: "You are Atsushi Nakajima. You are kind, unsure of yourself, eager to help, and slightly timid. You are the weretiger of the Armed Detective Agency.",
        [BsdCharacter.AKUTAGAWA]: "You are Ryunosuke Akutagawa. You are ruthless, obsessed with gaining Dazai's approval, and believe the weak should die. You wield Rashomon.",
        [BsdCharacter.RANPO]: "You are Ranpo Edogawa. You are the greatest detective in the world. You are childish, lazy, and demand sweets/snacks. You don't have an ability but pretend you do (Super Deduction).",
        [BsdCharacter.FYODOR]: "You are Fyodor Dostoevsky. You are calm, manipulative, and deeply religious in a twisted way. You believe ability users are sinners who must be punished.",
        [BsdCharacter.NIKOLAI]: "You are Nikolai Gogol. You are theatrical, insane, and obsessed with the concept of freedom. You love asking quizzes and acting like a clown.",
        [BsdCharacter.KUNIKIDA]: "You are Doppo Kunikida. You are strict, idealistic, and obsessed with your schedule and notebook. You hate when things go off-schedule or when Dazai slacks off.",
        [BsdCharacter.YOSANO]: "You are Akiko Yosano. You are the Agency's doctor. You are somewhat sadistic in your treatment methods but deeply value life. You are tough and confident.",
        [BsdCharacter.POE]: "You are Edgar Allan Poe. You are shy, anxious, and view Ranpo as your rival. You often have a raccoon named Karl with you."
      };
      const MODE_INSTRUCTIONS = {
        [AppMode.CHAT]: "",
        [AppMode.CHESS]: "You are a Chess Grandmaster. We are playing a game of chess. I will play white, or you can start. CRITICAL: After every single move you make, you MUST output the board state in FEN format wrapped in double brackets like this: [[FEN: rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1]]. Do not explain the FEN, just output it at the end of your response.",
        [AppMode.CODING]: "You are an expert Senior Software Engineer. You write clean, efficient, modern, and well-documented code. Prefer TypeScript, React, and Python unless asked otherwise. Always explain your architectural decisions. IMPORTANT: Always wrap your code in Markdown code blocks (```language ... ```).",
        [AppMode.SCRIPT_WRITER]: "You are an award-winning Screenwriter. Format your responses as a professional screenplay (Sluglines, Action, Character Name centered, Dialogue). Focus on showing, not telling."
      };
      const SPEED_CONFIGS = {
        [AiSpeed.DEEP_THINKING]: { model: 'gemini-1.5-pro', thinkingBudget: 0 },
        [AiSpeed.NORMAL]: { model: 'gemini-2.0-flash', thinkingBudget: 0 },
        [AiSpeed.FAST]: { model: 'gemini-2.0-flash', thinkingBudget: 0 },
        [AiSpeed.VERY_FAST]: { model: 'gemini-2.0-flash-lite-preview-02-05', thinkingBudget: 0 },
        [AiSpeed.EXTREMELY_FAST]: { model: 'gemini-2.0-flash-lite-preview-02-05', thinkingBudget: 0 }
      };

      const THEME_COLORS = {
        [AppTheme.DARK]: {
          bg: '#030712', nav: '#111827', card: '#1f2937', border: '#374151', text: '#f3f4f6', textSec: '#9ca3af', accent: '#8b5cf6', inputBg: '#0f172a', userBubble: '#374151', botBubble: '#1f2937', prose: 'prose-invert'
        },
        [AppTheme.LIGHT]: {
          bg: '#f3f4f6', nav: '#ffffff', card: '#ffffff', border: '#e5e7eb', text: '#111827', textSec: '#4b5563', accent: '#7c3aed', inputBg: '#ffffff', userBubble: '#e5e7eb', botBubble: '#ffffff', prose: 'prose-gray'
        },
        [AppTheme.LILA]: {
          bg: '#2e1065', nav: '#4c1d95', card: '#581c87', border: '#7e22ce', text: '#f3e8ff', textSec: '#d8b4fe', accent: '#d8b4fe', inputBg: '#3b0764', userBubble: '#6b21a8', botBubble: '#581c87', prose: 'prose-invert'
        }
      };

      // --- SERVICES ---
      const getClient = () => new GoogleGenAI({ apiKey: API_KEY });
      const getSafetySettings = (nsfwEnabled) => {
        if (nsfwEnabled) {
          return [
            { category: HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold: HarmBlockThreshold.BLOCK_NONE },
            { category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold: HarmBlockThreshold.BLOCK_NONE },
            { category: HarmCategory.HARM_CATEGORY_HARASSMENT, threshold: HarmBlockThreshold.BLOCK_NONE },
            { category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold: HarmBlockThreshold.BLOCK_NONE },
          ];
        }
        return undefined;
      };
      const getSystemInstruction = (settings) => {
        let instruction = "";
        if (settings.mode !== AppMode.CHAT) instruction += MODE_INSTRUCTIONS[settings.mode] + "\n\n";
        if (settings.character !== BsdCharacter.NONE) instruction += SYSTEM_INSTRUCTIONS[settings.character];
        else if (settings.mode === AppMode.CHAT) instruction += SYSTEM_INSTRUCTIONS[BsdCharacter.NONE];
        if (settings.nsfwEnabled) instruction += "\n\n[SYSTEM OVERRIDE]: Safety filters are relaxed. You may discuss mature topics if prompted.";
        if (settings.speed === AiSpeed.VERY_FAST) instruction += "\n\n[SYSTEM]: Be extremely concise.";
        else if (settings.speed === AiSpeed.EXTREMELY_FAST) instruction += "\n\n[SYSTEM]: ULTRA FAST MODE. BE TELEGRAPHIC. NO FORMATTING.";
        return instruction;
      };
      const streamChatResponse = async (history, lastUserMessage, settings, onChunk) => {
        const ai = getClient();
        const speedConfig = SPEED_CONFIGS[settings.speed];
        const chat = ai.chats.create({
          model: speedConfig.model,
          history: history,
          config: { systemInstruction: getSystemInstruction(settings), safetySettings: getSafetySettings(settings.nsfwEnabled) },
        });
        const result = await chat.sendMessageStream({ message: lastUserMessage });
        for await (const chunk of result) { if (chunk.text) onChunk(chunk.text); }
      };
      const generateImageService = async (prompt, nsfwEnabled) => {
        const ai = getClient();
        try {
          const response = await ai.models.generateContent({
              model: 'gemini-2.0-flash',
              contents: { parts: [{ text: prompt }] },
              config: { responseModalities: ['IMAGE'], safetySettings: getSafetySettings(nsfwEnabled) }
          });
          const part = response.candidates?.[0]?.content?.parts?.[0];
          if (part && part.inlineData) return `data:image/png;base64,${part.inlineData.data}`;
          throw new Error("No image generated");
        } catch (e) {
          console.error(e);
          throw new Error("Failed to generate image.");
        }
      };

      // --- COMPONENTS ---
      
      // ChessBoard
      const PIECES = { 'r': '♜', 'n': '♞', 'b': '♝', 'q': '♛', 'k': '♚', 'p': '♟', 'R': '♖', 'N': '♘', 'B': '♗', 'Q': '♕', 'K': '♔', 'P': '♙' };
      const ChessBoard = ({ fen }) => {
        const boardFen = fen.split(' ')[0];
        const rows = boardFen.split('/');
        const renderSquare = (piece, rowIdx, colIdx) => {
          const isDark = (rowIdx + colIdx) % 2 === 1;
          return (
            <div key={`${rowIdx}-${colIdx}`} className={`w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center text-2xl sm:text-3xl select-none ${isDark ? 'bg-gray-700/50 text-gray-200' : 'bg-gray-200 text-gray-900'}`}>
              {piece && <span className={piece === piece.toUpperCase() ? 'text-white drop-shadow-md' : 'text-black'}>{PIECES[piece]}</span>}
            </div>
          );
        };
        const board = [];
        for (let r = 0; r < 8; r++) {
          const rowData = rows[r] || "8";
          let col = 0;
          for (let i = 0; i < rowData.length; i++) {
            const char = rowData[i];
            if (!isNaN(parseInt(char))) {
              const emptyCount = parseInt(char);
              for (let k = 0; k < emptyCount; k++) { board.push(renderSquare(null, r, col)); col++; }
            } else { board.push(renderSquare(char, r, col)); col++; }
          }
        }
        return (
          <div className="inline-block border-4 border-gray-700 rounded shadow-xl bg-gray-800 my-4">
            <div className="grid grid-cols-8 gap-0 bg-gray-900">{board}</div>
            <div className="text-center py-1 text-xs text-gray-400 bg-gray-900 font-mono">{fen.split(' ')[1] === 'w' ? "White to move" : "Black to move"}</div>
          </div>
        );
      };

      // SettingsModal
      const SettingsModal = ({ isOpen, onClose, settings, setSettings }) => {
        if (!isOpen) return null;
        const theme = THEME_COLORS[settings.theme];
        const handleChange = (key, value) => setSettings(prev => ({ ...prev, [key]: value }));
        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
            <div className="border rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden transition-colors duration-300"
                 style={{ backgroundColor: theme.card, borderColor: theme.border, color: theme.text }}>
              <div className="flex justify-between items-center p-5 border-b" style={{ borderColor: theme.border, backgroundColor: theme.nav }}>
                <h2 className="text-xl font-bold flex items-center gap-2" style={{ color: theme.text }}><Activity style={{ color: theme.accent }} /> Performance</h2>
                <button onClick={onClose} className="hover:opacity-70"><X size={24} style={{ color: theme.textSec }} /></button>
              </div>
              <div className="p-6 space-y-6">
                 <div>
                    <label className="block text-sm font-medium mb-3 flex items-center gap-2" style={{ color: theme.textSec }}><Palette size={16} /> Theme</label>
                    <div className="grid grid-cols-3 gap-3">
                      {[{ val: AppTheme.DARK, label: 'Dark', icon: <Moon size={16}/> }, { val: AppTheme.LIGHT, label: 'Light', icon: <Sun size={16}/> }, { val: AppTheme.LILA, label: 'Lila', icon: <Palette size={16}/> }].map((opt) => (
                        <button key={opt.val} onClick={() => handleChange('theme', opt.val)} className={`p-3 rounded-xl border transition-all flex flex-col items-center gap-2 ${settings.theme === opt.val ? 'shadow-md' : 'hover:opacity-80'}`}
                          style={{ backgroundColor: settings.theme === opt.val ? `${theme.accent}33` : theme.bg, borderColor: settings.theme === opt.val ? theme.accent : theme.border, color: settings.theme === opt.val ? theme.text : theme.textSec }}>
                          {opt.icon}<span className="text-sm font-bold">{opt.label}</span>
                        </button>
                      ))}
                    </div>
                  </div>
                <div>
                  <label className="block text-sm font-medium mb-3 flex items-center gap-2" style={{ color: theme.textSec }}><Zap size={16} /> Speed</label>
                  <div className="grid grid-cols-1 gap-3">
                    {[
                      { val: AiSpeed.DEEP_THINKING, label: 'Deep Thinking', desc: 'Gemini 1.5 Pro' },
                      { val: AiSpeed.NORMAL, label: 'Normal', desc: 'Gemini 2.0 Flash' },
                      { val: AiSpeed.FAST, label: 'Fast', desc: 'Gemini 2.0 Flash' },
                      { val: AiSpeed.VERY_FAST, label: 'Very Fast', desc: 'Flash Lite' },
                      { val: AiSpeed.EXTREMELY_FAST, label: 'Extremely Fast', desc: 'Flash Lite Minimal' },
                    ].map((opt) => (
                      <button key={opt.val} onClick={() => handleChange('speed', opt.val)} className={`p-4 rounded-xl border text-left transition-all flex justify-between items-center ${settings.speed === opt.val ? 'shadow-md' : 'hover:opacity-90'}`} style={{ backgroundColor: settings.speed === opt.val ? `${theme.accent}20` : theme.bg, borderColor: settings.speed === opt.val ? theme.accent : theme.border, color: settings.speed === opt.val ? theme.text : theme.textSec }}>
                        <div><div className="font-bold text-sm">{opt.label}</div><div className="text-xs opacity-70">{opt.desc}</div></div>
                        {settings.speed === opt.val && <div className="w-3 h-3 rounded-full shadow-[0_0_10px_rgba(139,92,246,0.8)]" style={{ backgroundColor: theme.accent }} />}
                      </button>
                    ))}
                  </div>
                </div>
              </div>
              <div className="p-5 border-t text-right" style={{ borderColor: theme.border, backgroundColor: theme.nav }}>
                <button onClick={onClose} className="text-white px-6 py-2 rounded-lg font-medium transition shadow-lg" style={{ backgroundColor: theme.accent }}>Close</button>
              </div>
            </div>
          </div>
        );
      };

      // ModesMenu
      const ModesMenu = ({ isOpen, onClose, settings, setSettings }) => {
        const [showPasswordInput, setShowPasswordInput] = useState(false);
        const [passwordAttempt, setPasswordAttempt] = useState('');
        const [errorMsg, setErrorMsg] = useState('');
        const theme = THEME_COLORS[settings.theme];
        if (!isOpen) return null;
        const handleSettingChange = (key, value) => setSettings(prev => ({ ...prev, [key]: value }));
        const handleNsfwToggle = () => {
          if (settings.nsfwEnabled) { handleSettingChange('nsfwEnabled', false); setShowPasswordInput(false); }
          else { setShowPasswordInput(true); setErrorMsg(''); setPasswordAttempt(''); }
        };
        const verifyPassword = () => {
          if (passwordAttempt === '0211') { handleSettingChange('nsfwEnabled', true); setShowPasswordInput(false); setPasswordAttempt(''); setErrorMsg(''); }
          else { setErrorMsg('Incorrect password'); setPasswordAttempt(''); }
        };
        const characters = [
          { id: BsdCharacter.NONE, name: 'Stellar AI', desc: 'Default Assistant' },
          { id: BsdCharacter.DAZAI, name: 'Osamu Dazai', desc: 'Enigmatic & Suicidal' },
          { id: BsdCharacter.CHUUYA, name: 'Chuuya Nakahara', desc: 'Gravity Manipulator' },
          { id: BsdCharacter.ATSUSHI, name: 'Atsushi Nakajima', desc: 'The Weretiger' },
          { id: BsdCharacter.AKUTAGAWA, name: 'Ryunosuke Akutagawa', desc: 'Silent Rabid Dog' },
          { id: BsdCharacter.RANPO, name: 'Ranpo Edogawa', desc: 'Super Deduction' },
          { id: BsdCharacter.FYODOR, name: 'Fyodor Dostoevsky', desc: 'Crime and Punishment' },
          { id: BsdCharacter.NIKOLAI, name: 'Nikolai Gogol', desc: 'The Clown' },
          { id: BsdCharacter.KUNIKIDA, name: 'Doppo Kunikida', desc: 'The Idealist' },
          { id: BsdCharacter.YOSANO, name: 'Akiko Yosano', desc: 'Thou Shalt Not Die' },
          { id: BsdCharacter.POE, name: 'Edgar Allan Poe', desc: 'Guild Architect' },
        ];
        const modes = [
          { id: AppMode.CHAT, name: 'Chat Mode', icon: <MessageSquare size={20}/>, desc: 'Standard conversation' },
          { id: AppMode.CHESS, name: 'Chess Mode', icon: <Swords size={20}/>, desc: 'Play against a Grandmaster' },
          { id: AppMode.CODING, name: 'Coding Mode', icon: <Code size={20}/>, desc: 'Software Engineering expert' },
          { id: AppMode.SCRIPT_WRITER, name: 'Script Writer', icon: <Film size={20}/>, desc: 'Screenplay formatting' },
        ];
        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
            <div className="border rounded-2xl w-full max-w-3xl shadow-2xl overflow-hidden flex flex-col max-h-[85vh]" style={{ backgroundColor: theme.card, borderColor: theme.border }}>
              <div className="flex justify-between items-center p-5 border-b" style={{ backgroundColor: theme.nav, borderColor: theme.border }}>
                <h2 className="text-xl font-bold flex items-center gap-2" style={{ color: theme.text }}><Star style={{ color: theme.accent }} /> Modes & Personas</h2>
                <button onClick={onClose} className="hover:opacity-70"><X size={24} style={{ color: theme.textSec }} /></button>
              </div>
              <div className="flex-1 overflow-y-auto p-6 space-y-8">
                <section>
                  <h3 className="text-sm font-semibold uppercase tracking-wider mb-4" style={{ color: theme.textSec }}>Operation Mode</h3>
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    {modes.map((mode) => (
                      <button key={mode.id} onClick={() => handleSettingChange('mode', mode.id)} className={`p-4 rounded-xl border text-left transition-all flex items-start gap-3 ${settings.mode === mode.id ? 'shadow-md' : 'hover:opacity-90'}`} style={{ backgroundColor: settings.mode === mode.id ? `${theme.accent}20` : theme.bg, borderColor: settings.mode === mode.id ? theme.accent : theme.border, color: settings.mode === mode.id ? theme.text : theme.textSec }}>
                        <div className="mt-1" style={{ color: settings.mode === mode.id ? theme.accent : theme.textSec }}>{mode.icon}</div>
                        <div><div className="font-bold" style={{ color: settings.mode === mode.id ? theme.text : theme.textSec }}>{mode.name}</div><div className="text-xs opacity-70">{mode.desc}</div></div>
                      </button>
                    ))}
                  </div>
                </section>
                <section>
                   <div className="flex justify-between items-center mb-4"><h3 className="text-sm font-semibold uppercase tracking-wider" style={{ color: theme.textSec }}>BSD Persona</h3></div>
                  <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3">
                    {characters.map((char) => (
                      <button key={char.id} onClick={() => handleSettingChange('character', char.id)} className={`p-3 rounded-xl border text-center transition-all flex flex-col items-center justify-center gap-2 h-28 ${settings.character === char.id ? 'shadow-md' : 'hover:opacity-90'}`} style={{ backgroundColor: settings.character === char.id ? `${theme.accent}20` : theme.bg, borderColor: settings.character === char.id ? theme.accent : theme.border, color: settings.character === char.id ? theme.text : theme.textSec }}>
                        <div className={`w-8 h-8 rounded-full flex items-center justify-center`} style={{ backgroundColor: settings.character === char.id ? theme.accent : theme.border, color: '#fff' }}><User size={16} /></div>
                        <div className="flex flex-col"><span className="font-bold text-sm leading-tight">{char.name}</span><span className="text-[10px] opacity-60 mt-1 line-clamp-1">{char.desc}</span></div>
                      </button>
                    ))}
                  </div>
                </section>
                <section className="border-t pt-6" style={{ borderColor: theme.border }}>
                  <h3 className="text-sm font-semibold text-red-400 uppercase tracking-wider mb-4 flex items-center gap-2"><AlertTriangle size={16} /> Restricted Settings</h3>
                   <div className="flex flex-col rounded-xl border border-red-900/30 overflow-hidden" style={{ backgroundColor: `${theme.bg}40` }}>
                     <div className="flex items-center justify-between p-4">
                        <div className="flex items-center gap-3">
                          <div className="p-2 bg-red-900/30 rounded-lg text-red-500">{settings.nsfwEnabled ? <AlertTriangle size={24} /> : <Lock size={24} />}</div>
                          <div><div className="font-bold" style={{ color: theme.text }}>NSFW Mode</div><div className="text-xs text-red-400/80">Disables safety filters.</div></div>
                        </div>
                        {!showPasswordInput && (
                          <button onClick={handleNsfwToggle} className={`relative inline-flex h-7 w-14 items-center rounded-full transition-colors ${settings.nsfwEnabled ? 'bg-red-600' : 'bg-gray-600'}`}>
                            <span className={`inline-block h-5 w-5 transform rounded-full bg-white transition ${settings.nsfwEnabled ? 'translate-x-8' : 'translate-x-1'}`} />
                          </button>
                        )}
                    </div>
                    {showPasswordInput && (
                       <div className="p-4 border-t border-red-900/30 flex flex-col gap-2" style={{ backgroundColor: `${theme.nav}80` }}>
                          <label className="text-xs text-red-400 font-mono uppercase">Enter Access Password:</label>
                          <div className="flex gap-2">
                            <input type="password" autoFocus className="flex-1 border border-red-900/50 rounded-lg px-3 py-2 focus:border-red-500 outline-none" style={{ backgroundColor: theme.bg, color: theme.text }} placeholder="Password..." value={passwordAttempt} onChange={(e) => setPasswordAttempt(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && verifyPassword()} />
                            <button onClick={verifyPassword} className="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded-lg font-bold text-sm transition">Unlock</button>
                            <button onClick={() => { setShowPasswordInput(false); setPasswordAttempt(''); setErrorMsg(''); }} className="px-3 py-2 rounded-lg text-sm transition text-white" style={{ backgroundColor: theme.border }}>Cancel</button>
                          </div>
                          {errorMsg && <div className="text-red-400 text-xs font-bold mt-1">{errorMsg}</div>}
                       </div>
                    )}
                  </div>
                </section>
              </div>
              <div className="p-5 border-t text-right" style={{ backgroundColor: theme.nav, borderColor: theme.border }}>
                <button onClick={onClose} className="text-white px-8 py-3 rounded-xl font-bold transition shadow-lg" style={{ backgroundColor: theme.accent }}>Done</button>
              </div>
            </div>
          </div>
        );
      };

      // ChatInterface
      const ChatInterface = ({ messages, input, setInput, onSend, isLoading, settings }) => {
        const messagesEndRef = useRef(null);
        const textareaRef = useRef(null);
        const theme = THEME_COLORS[settings.theme];
        useEffect(() => messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }), [messages]);
        useEffect(() => { if (textareaRef.current) { textareaRef.current.style.height = 'auto'; textareaRef.current.style.height = textareaRef.current.scrollHeight + 'px'; } }, [input]);
        const handleKeyDown = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); onSend(); } };
        const getPlaceholder = () => {
          if (settings.mode === AppMode.CHESS) return "Your move (e.g., e4, Nf3)...";
          if (settings.mode === AppMode.CODING) return "Ask for code or architectural advice...";
          if (settings.mode === AppMode.SCRIPT_WRITER) return "Describe a scene or dialogue...";
          return "Message Stellar AI...";
        };
        const processMessageContent = (text) => {
          const fenRegex = /\[\[FEN: (.*?)\]\]/;
          const match = text.match(fenRegex);
          let content = text;
          let fen = null;
          if (match) { fen = match[1]; content = text.replace(fenRegex, '').trim(); }
          return { content, fen };
        };
        const renderEmptyStateIcon = () => {
          switch (settings.mode) {
            case AppMode.CHESS: return <Swords size={48} style={{ color: theme.accent }} />;
            case AppMode.CODING: return <Code size={48} style={{ color: theme.accent }} />;
            case AppMode.SCRIPT_WRITER: return <Film size={48} style={{ color: theme.accent }} />;
            default: return <Cpu size={48} style={{ color: theme.accent }} />;
          }
        };
        return (
          <div className="flex flex-col h-full relative transition-colors duration-300" style={{ backgroundColor: theme.bg }}>
            <div className="flex-1 overflow-y-auto p-4 sm:p-6 space-y-6 scrollbar-thin">
              {messages.length === 0 && (
                <div className="h-full flex flex-col items-center justify-center text-center opacity-60" style={{ color: theme.textSec }}>
                  <div className="p-6 rounded-full mb-6 animate-pulse-slow relative group" style={{ backgroundColor: theme.card }}>{renderEmptyStateIcon()}</div>
                  <h2 className="text-2xl font-bold mb-2" style={{ color: theme.text }}>Stellar AI Online</h2>
                  <p className="max-w-md mx-auto">{settings.mode === AppMode.CHESS ? "Chess Engine initialized." : settings.mode === AppMode.CODING ? "Coding Mode active." : "Select a persona or start typing to begin."}</p>
                </div>
              )}
              {messages.map((msg) => {
                const { content, fen } = processMessageContent(msg.text);
                return (
                  <div key={msg.id} className={`flex w-full ${msg.role === MessageRole.USER ? 'justify-end' : 'justify-start'}`}>
                    <div className={`flex max-w-[90%] sm:max-w-[80%] gap-3 ${msg.role === MessageRole.USER ? 'flex-row-reverse' : 'flex-row'}`}>
                      <div className={`w-8 h-8 sm:w-10 sm:h-10 rounded-xl flex items-center justify-center flex-shrink-0 shadow-lg border`} style={{ backgroundColor: msg.role === MessageRole.USER ? theme.card : theme.accent, borderColor: theme.border, color: msg.role === MessageRole.USER ? theme.text : '#fff' }}>
                        {msg.role === MessageRole.USER ? <User size={18} /> : <Bot size={18} />}
                      </div>
                      <div className="flex flex-col gap-2">
                          {content && (
                            <div className={`p-3 sm:p-5 rounded-2xl text-sm sm:text-base leading-relaxed shadow-md ${msg.role === MessageRole.USER ? 'rounded-tr-none' : 'rounded-tl-none border'}`} style={{ backgroundColor: msg.role === MessageRole.USER ? theme.userBubble : theme.botBubble, color: theme.text, borderColor: theme.border }}>
                              <ReactMarkdown className={`prose ${theme.prose} prose-p:my-1 prose-pre:p-3 prose-pre:rounded-lg prose-pre:border max-w-none`} components={{ code: ({node, className, children, ...props}) => { const match = /language-(\w+)/.exec(className || ''); const isInline = !match && !String(children).includes('\n'); return isInline ? (<code className="px-1 py-0.5 rounded font-mono text-xs sm:text-sm border" style={{ backgroundColor: `${theme.bg}AA`, borderColor: theme.border, color: theme.accent }} {...props}>{children}</code>) : (<code className={className} {...props}>{children}</code>); } }}>{content}</ReactMarkdown>
                              {msg.role === MessageRole.MODEL && isLoading && msg.id === messages[messages.length - 1].id && content.length === 0 && <span className="inline-block w-2 h-4 animate-pulse ml-1" style={{ backgroundColor: theme.accent }}/>}
                            </div>
                          )}
                          {fen && <ChessBoard fen={fen} />}
                      </div>
                    </div>
                  </div>
                );
              })}
              <div ref={messagesEndRef} />
            </div>
            <div className="p-4 backdrop-blur border-t" style={{ borderColor: theme.border, backgroundColor: `${theme.bg}CC` }}>
              <div className="max-w-4xl mx-auto relative flex items-end gap-2 p-2 rounded-xl border transition-colors shadow-lg" style={{ backgroundColor: theme.inputBg, borderColor: theme.border }}>
                <textarea ref={textareaRef} value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={handleKeyDown} placeholder={getPlaceholder()} className="flex-1 bg-transparent p-3 focus:outline-none resize-none max-h-32 min-h-[48px]" style={{ color: theme.text }} rows={1} />
                <button onClick={onSend} disabled={isLoading || !input.trim()} className="p-3 rounded-lg text-white transition-all flex-shrink-0 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" style={{ backgroundColor: theme.accent }}>
                  {isLoading ? <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" /> : <Send size={20} />}
                </button>
              </div>
              <div className="text-center mt-2 text-[10px] uppercase tracking-widest font-medium" style={{ color: theme.textSec }}>{settings.mode.replace('_', ' ')} • {settings.nsfwEnabled ? 'UNRESTRICTED' : 'SECURE'} • {settings.character !== BsdCharacter.NONE ? settings.character : 'STANDARD'}</div>
            </div>
          </div>
        );
      };

      // ImageGenerator
      const ImageGenerator = ({ settings }) => {
        const [prompt, setPrompt] = useState('');
        const [isLoading, setIsLoading] = useState(false);
        const [generatedImages, setGeneratedImages] = useState([]);
        const [error, setError] = useState(null);
        const theme = THEME_COLORS[settings.theme];
        const handleGenerate = async () => {
          if (!prompt.trim()) return;
          setIsLoading(true); setError(null);
          try {
            const imageUrl = await generateImageService(prompt, settings.nsfwEnabled);
            setGeneratedImages(prev => [{ id: Date.now().toString(), url: imageUrl, prompt: prompt }, ...prev]);
            setPrompt('');
          } catch (err) { setError("Failed to generate image. Try a different prompt or check safety settings."); } finally { setIsLoading(false); }
        };
        return (
          <div className="flex flex-col h-full p-4 sm:p-8 overflow-y-auto transition-colors duration-300" style={{ backgroundColor: theme.bg }}>
            <div className="max-w-5xl mx-auto w-full space-y-8">
              <div className="text-center space-y-2"><h1 className="text-3xl font-bold text-transparent bg-clip-text" style={{ backgroundImage: `linear-gradient(to right, ${theme.accent}, ${theme.textSec})` }}>Stellar Vision</h1><p style={{ color: theme.textSec }}>Generate high-quality images.</p></div>
              <div className="p-4 rounded-2xl border shadow-xl" style={{ backgroundColor: theme.card, borderColor: theme.border }}>
                <div className="flex flex-col sm:flex-row gap-4">
                  <input type="text" value={prompt} onChange={(e) => setPrompt(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleGenerate()} placeholder="Describe the image..." className="flex-1 rounded-xl px-4 py-3 outline-none border" style={{ backgroundColor: theme.bg, borderColor: theme.border, color: theme.text }} />
                  <button onClick={handleGenerate} disabled={isLoading || !prompt.trim()} className="text-white px-6 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:opacity-90 transition disabled:opacity-50 min-w-[140px]" style={{ backgroundColor: theme.accent }}>
                    {isLoading ? <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" /> : <><Sparkles size={18} /> Generate</>}
                  </button>
                </div>
                {error && <p className="mt-3 text-red-400 text-sm text-center">{error}</p>}
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {generatedImages.map((img) => (
                  <div key={img.id} className="group relative rounded-xl overflow-hidden border shadow-lg transition" style={{ borderColor: theme.border, backgroundColor: theme.card }}>
                    <img src={img.url} alt={img.prompt} className="w-full h-64 object-cover" />
                    <div className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col justify-end p-4 bg-gradient-to-t from-black/80 to-transparent">
                      <p className="text-white text-sm line-clamp-2 mb-2">{img.prompt}</p>
                      <a href={img.url} download={`stellar-ai-${img.id}.png`} className="bg-white/20 backdrop-blur hover:bg-white/30 text-white py-2 rounded-lg flex items-center justify-center gap-2 text-sm font-medium transition"><Download size={16} /> Download</a>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      };

      // App
      const StellarLogo = () => (
        <svg width="32" height="32" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M20 0L24.49 15.51L40 20L24.49 24.49L20 40L15.51 24.49L0 20L15.51 15.51L20 0Z" fill="url(#grad1)"/>
          <circle cx="20" cy="20" r="5" fill="white" fillOpacity="0.9"/>
          <defs><linearGradient id="grad1" x1="0" y1="0" x2="40" y2="40" gradientUnits="userSpaceOnUse"><stop stopColor="#a78bfa" /><stop offset="1" stopColor="#7c3aed" /></linearGradient></defs>
        </svg>
      );

      function App() {
        const [activeTab, setActiveTab] = useState('chat');
        const [isSettingsOpen, setIsSettingsOpen] = useState(false);
        const [isModesMenuOpen, setIsModesMenuOpen] = useState(false);
        const [settings, setSettings] = useState({ speed: AiSpeed.NORMAL, nsfwEnabled: false, mode: AppMode.CHAT, character: BsdCharacter.NONE, theme: AppTheme.DARK });
        const theme = THEME_COLORS[settings.theme];
        const [input, setInput] = useState('');
        const [messages, setMessages] = useState([]);
        const [isLoading, setIsLoading] = useState(false);

        const handleSend = async () => {
          if (!input.trim() || isLoading) return;
          const userMsg = { id: Date.now().toString(), role: MessageRole.USER, text: input, timestamp: Date.now() };
          const tempModelMsg = { id: (Date.now() + 1).toString(), role: MessageRole.MODEL, text: '', timestamp: Date.now() };
          setMessages(prev => [...prev, userMsg, tempModelMsg]);
          setInput('');
          setIsLoading(true);
          try {
            const history = messages.map(m => ({ role: m.role === MessageRole.USER ? 'user' : 'model', parts: [{ text: m.text }] }));
            await streamChatResponse(history, userMsg.text, settings, (textChunk) => {
              setMessages(current => {
                const newMsgs = [...current];
                const lastMsg = newMsgs[newMsgs.length - 1];
                if (lastMsg.role === MessageRole.MODEL) lastMsg.text += textChunk;
                return newMsgs;
              });
            });
          } catch (error) {
            setMessages(current => {
               const newMsgs = [...current];
               const lastMsg = newMsgs[newMsgs.length - 1];
               lastMsg.text = "**Error:** Failed to get response.";
               return newMsgs;
            });
          } finally { setIsLoading(false); }
        };

        return (
          <div className="flex h-screen font-sans overflow-hidden selection:bg-purple-500/30 transition-colors duration-300" style={{ backgroundColor: theme.bg, color: theme.text }}>
            <nav className="hidden md:flex flex-col w-20 border-r items-center py-6 gap-6 z-20 shadow-2xl transition-colors duration-300" style={{ backgroundColor: theme.nav, borderColor: theme.border }}>
              <div className="mb-4 hover:scale-110 transition-transform duration-300 cursor-default"><StellarLogo /></div>
              <button onClick={() => setActiveTab('chat')} className={`p-3 rounded-xl transition-all relative group`} style={{ backgroundColor: activeTab === 'chat' ? theme.card : 'transparent', color: activeTab === 'chat' ? theme.accent : theme.textSec }}><MessageSquare size={24} />{activeTab === 'chat' && <div className="absolute inset-y-2 left-0 w-1 rounded-r-full" style={{ backgroundColor: theme.accent }} />}</button>
              <button onClick={() => setActiveTab('image')} className={`p-3 rounded-xl transition-all relative group`} style={{ backgroundColor: activeTab === 'image' ? theme.card : 'transparent', color: activeTab === 'image' ? theme.accent : theme.textSec }}><ImageIcon size={24} />{activeTab === 'image' && <div className="absolute inset-y-2 left-0 w-1 rounded-r-full" style={{ backgroundColor: theme.accent }} />}</button>
              <div className="w-8 h-[1px] my-2" style={{ backgroundColor: theme.border }} />
              <button onClick={() => setIsModesMenuOpen(true)} className="p-3 rounded-xl transition-all group relative hover:bg-opacity-10" style={{ color: theme.textSec }}><Grid2X2 size={24} /></button>
              <div className="mt-auto flex flex-col gap-4">
                 <a href="https://github.com" target="_blank" className="p-3 transition" style={{ color: theme.textSec }}><Github size={24} /></a>
                <button onClick={() => setIsSettingsOpen(true)} className="p-3 hover:rotate-90 transition duration-300" style={{ color: theme.textSec }}><Settings size={24} /></button>
              </div>
            </nav>
            <div className="md:hidden fixed top-0 left-0 right-0 h-16 backdrop-blur border-b flex items-center justify-between px-4 z-30 transition-colors" style={{ backgroundColor: `${theme.nav}E6`, borderColor: theme.border }}>
               <div className="font-bold text-xl flex items-center gap-3" style={{ color: theme.text }}><StellarLogo /><span className="tracking-tight">Stellar AI</span></div>
               <div className="flex gap-2">
                 <button onClick={() => setIsModesMenuOpen(true)} className="p-2" style={{ color: theme.textSec }}><Grid2X2 size={22} /></button>
                 <button onClick={() => setIsSettingsOpen(true)} className="p-2" style={{ color: theme.textSec }}><Settings size={22} /></button>
               </div>
            </div>
            <div className="md:hidden fixed bottom-0 left-0 right-0 h-16 border-t flex items-center justify-around z-30 transition-colors" style={{ backgroundColor: theme.nav, borderColor: theme.border }}>
              <button onClick={() => setActiveTab('chat')} className={`flex flex-col items-center gap-1`} style={{ color: activeTab === 'chat' ? theme.accent : theme.textSec }}><MessageSquare size={20} /><span className="text-[10px]">Chat</span></button>
              <button onClick={() => setActiveTab('image')} className={`flex flex-col items-center gap-1`} style={{ color: activeTab === 'image' ? theme.accent : theme.textSec }}><ImageIcon size={20} /><span className="text-[10px]">Images</span></button>
            </div>
            <main className="flex-1 relative pt-16 md:pt-0 pb-16 md:pb-0 h-[100dvh]">
              {activeTab === 'chat' ? <ChatInterface messages={messages} input={input} setInput={setInput} onSend={handleSend} isLoading={isLoading} settings={settings} /> : <ImageGenerator settings={settings} />}
            </main>
            <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} settings={settings} setSettings={setSettings} />
            <ModesMenu isOpen={isModesMenuOpen} onClose={() => setIsModesMenuOpen(false)} settings={settings} setSettings={setSettings} />
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>